<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Map Generator</title>
</head>
<script>
    class World{
        constructor(size,
                    aliveChance,
                    aliveNum,
                    deathNum,
                    treeChance,
                    stoneChance,
                    reconstructRange,
                    mountainChance,
                    mountainChanceNearWater,
                    mountainReconstructRange,
                    stoneAliveChance,
                    snowReconstructRange,
                    beachRange,
                    goldVeinChance){
            this.size = size;
            this.aliveChance = aliveChance;
            this.aliveNum = aliveNum
            this.deathNum = deathNum;
            this.reconstructRange = reconstructRange;
            this.treeChance = treeChance;
            this.stoneChance = stoneChance;
            this.mountainChance = mountainChance;
            this.mountainChanceNearWater = mountainChanceNearWater;
            this.mountainReconstructRange = mountainReconstructRange;
            this.stoneAliveChance = stoneAliveChance;
            this.snowReconstructRange = snowReconstructRange;
            this.beachRange = beachRange;
            this.goldVeinChance = goldVeinChance;
            this.map = [];
            this.goldVeins = [];
            this.goldVeinsGrowChance = 0.4;
        }
        generateRandom(){
            for ( let i = 0 ; i < this.size ; i++ ) {
                this.map[i] = [];
                for ( let m = 0 ; m < this.size ; m++ ) {
                    if ( this.random() > this.aliveChance ) {
                        this.map[i][m] = 1;
                    } else {
                        this.map[i][m] = 0;
                    }
                }
            }
            this.paintMapOnCanvas();
        }
        random(){
            return Math.random();
        }
        setMap(newMap){
            this.map = newMap;
            this.paintMapOnCanvas();
        }
        reconstructPixel(map, x, y){
            let aliveNeighbours = 0;
            for ( let i = (x - this.reconstructRange) ; i < (x + this.reconstructRange) ; i++ ) {
                for ( let m = (y - this.reconstructRange) ; m < (y + this.reconstructRange) ; m++ ) {
                    let _x = 0;
                    let _y = 0;
                    if ( i === 0 && m === 0 ) {
                        //do nothing
                    } else {
                        _x = this.periodicFunction(this.size, i);
                        _y = this.periodicFunction(this.size, m);
                        if ( map[_x][_y] === 1 ) {
                            aliveNeighbours = aliveNeighbours+1;
                        }
                    }
                }
            }
            if ( map[x][y] ) {
                if ( aliveNeighbours < this.deathNum ){
                    return 0;
                } else {
                    return 1;
                }
            } else {
                if ( aliveNeighbours > this.aliveNum ){
                    return 1;
                } else {
                    return 0;
                }
            }
        }
        reconstructPixelForTree(map, x, y){
            let aliveNeighbours = 0;
            for ( let i = (x - this.reconstructRange) ; i < (x + this.reconstructRange) ; i++ ) {
                for ( let m = (y - this.reconstructRange) ; m < (y + this.reconstructRange) ; m++ ) {
                    let _x = 0;
                    let _y = 0;
                    if ( i === 0 && m === 0 ) {
                        //do nothing
                    } else {
                        _x = this.periodicFunction(this.size, i);
                        _y = this.periodicFunction(this.size, m);

                        if (map[_x][_y] === 2) {
                            aliveNeighbours = aliveNeighbours + 1;
                        } else if (map[_x][_y] === 0) {
                            aliveNeighbours = aliveNeighbours + 1;
                        } else if (map[_x][_y] === 1) {
                            aliveNeighbours = aliveNeighbours - 1;
                        }
                    }
                }
            }
            if ( map[x][y] === 1 ) {
                if ( aliveNeighbours < this.deathNum ){
                    return 1;
                } else {
                    return 2;
                }
            } else if ( map[x][y] === 2 ) {
                if ( aliveNeighbours > this.aliveNum ){
                    return 2;
                } else {
                    return 1;
                }
            } else if ( map[x][y] === 0 ) {
                return 0;
            }
        }
        reconstructMap(times){
            for (let t = 0 ; t < times ; t++ ) {
                let newMap = [];
                for ( let i = 0 ; i < this.size ; i++ ) {
                    newMap[i] = [];
                    for ( let m = 0 ; m < this.size ; m++ ) {
                        newMap[i][m] = this.reconstructPixel(this.map, i, m);
                    }
                }
                this.setMap(newMap);
            }
        }
        plantTrees(){
            for ( let i = 0 ; i < this.size ; i++ ) {
                for ( let m = 0 ; m < this.size ; m++ ) {
                    if ( this.random() > this.treeChance && this.map[i][m] == 1 ) {
                        this.map[i][m] = 2;
                    }
                }
            }
            this.paintMapOnCanvas();
        }
        reconstructTrees(times){
            for (let t = 0 ; t < times ; t++ ) {
                let newMap = [];
                for ( let i = 0 ; i < this.size ; i++ ) {
                    newMap[i] = [];
                    for ( let m = 0 ; m < this.size ; m++ ) {
                        newMap[i][m] = this.reconstructPixelForTree(this.map, i, m);
                    }
                }
                this.setMap(newMap);
            }
        }
        placeStones(){
            for ( let i = 0 ; i < this.size ; i++ ) {
                for ( let m = 0 ; m < this.size ; m++ ) {
                    if ( this.random() > this.stoneChance && this.map[i][m] == 1 ) {
                        this.map[i][m] = 3;
                    }
                }
            }
            this.paintMapOnCanvas();
        }
        reconstructStones(times){
            for (let t = 0 ; t < times ; t++ ) {
                let newMap = [];
                for ( let i = 0 ; i < this.size ; i++ ) {
                    newMap[i] = [];
                    for ( let m = 0 ; m < this.size ; m++ ) {
                        if ( this.map[i][m] == 1 ||
                            this.map[i][m] == 2 ||
                            this.map[i][m] == 3 ) {
                            newMap[i][m] = this.reconstructStoneForMountain(this.map, i, m);
                        } else {
                            newMap[i][m] = this.map[i][m];
                        }
                    }
                }
                this.setMap(newMap);
            }
        }
        periodicFunction(size, iterator){
            let val = 0;
            if ( iterator < 0 ) {
                val = size + iterator;
            } else if ( iterator >= size ) {
                val = iterator - size;
            } else {
                val = iterator;
            }
            return val;
        }
        reconstructStoneForMountain(map, x, y){
            let stonesNearby = 0;
            let waterNearby = 0;
            for ( let i = (x - this.mountainReconstructRange) ; i < (x + this.mountainReconstructRange) ; i++ ) {
                for ( let m = (y - this.mountainReconstructRange) ; m < (y + this.mountainReconstructRange) ; m++ ) {
                    let _x = 0;
                    let _y = 0;
                    if ( i === 0 && m === 0 ) {
                        //do nothing
                    } else {
                        _x = this.periodicFunction(this.size, i);
                        _y = this.periodicFunction(this.size, m);
                        if ( map[_x][_y] === 3 ) {
                            stonesNearby = stonesNearby + 1;
                        } else if ( map[_x][_y] === 0 ) {
                            waterNearby = waterNearby + 1;
                        }
                    }
                }
            }

            if ( map[x][y] === 1 ) {
                if ( stonesNearby > this.mountainChance ) {
                    return 3;
                } else {
                    if ( waterNearby > this.mountainChanceNearWater ) {
                        return 3;
                    } else {
                        return 1;
                    }
                }
            } else if ( map[x][y] === 2 ) {
                if ( stonesNearby > this.mountainChance ) {
                    if ( waterNearby > this.mountainChanceNearWater ) {
                        return 3;
                    } else {
                        return 2;
                    }
                } else {
                    return 2;
                }
            } else if ( map[x][y] === 3 ) {
                if ( stonesNearby <= this.stoneAliveChance ) {
                    if (  waterNearby > this.mountainChanceNearWater ) {
                        return 3;
                    } else {
                        return 1;
                    }
                } else {
                    return 3;
                }
            }
        }
        placeSnowOnMountainPeaks() {
            let newMap = [];
            for (let i = 0; i < this.size; i++) {
                newMap[i] = [];
                for (let m = 0; m < this.size; m++) {
                    if (this.map[i][m] === 3) {
                        newMap[i][m] = this.reconstructStoneForSnow(this.map, i, m);
                    } else {
                        newMap[i][m] = this.map[i][m];
                    }
                }
            }
            this.setMap(newMap);
        }
        reconstructStoneForSnow(map, x, y){
            let onlyStonesNearby = true;
            for ( let i = (x - this.snowReconstructRange) ; i < (x + this.snowReconstructRange) ; i++ ) {
                for ( let m = (y - this.snowReconstructRange) ; m < (y + this.snowReconstructRange) ; m++ ) {
                    let _x = 0;
                    let _y = 0;
                    if ( i === 0 && m === 0 ) {
                        //do nothing
                    } else {
                        _x = this.periodicFunction(this.size, i);
                        _y = this.periodicFunction(this.size, m);
                        if ( map[_x][_y] !== 3 ) {
                            onlyStonesNearby = false;
                        }
                    }
                }
            }
            return onlyStonesNearby ? 4 : 3;
        }
        placeBeaches() {
            let newMap = [];
            for (let i = 0; i < this.size; i++) {
                newMap[i] = [];
                for (let m = 0; m < this.size; m++) {
                    if (this.map[i][m] === 1) {
                        newMap[i][m] = this.reconstructGrassForBeach(this.map, i, m);
                    } else {
                        newMap[i][m] = this.map[i][m];
                    }
                }
            }
            this.setMap(newMap);
        }
        reconstructGrassForBeach(map, x, y){
            let treesNearby = false;
            let waterNearby = false;
            let sandNearby = false;
            for ( let i = (x - this.beachRange) ; i < (x + this.beachRange) ; i++ ) {
                for ( let m = (y - this.beachRange) ; m < (y + this.beachRange) ; m++ ) {
                    let _x = 0;
                    let _y = 0;
                    if ( i === 0 && m === 0 ) {
                        //do nothing
                    } else {
                        _x = this.periodicFunction(this.size, i);
                        _y = this.periodicFunction(this.size, m);
                        if ( map[_x][_y] === 2  ) {
                            treesNearby = true;
                        }
                        if ( map[_x][_y] === 0 ) {
                            waterNearby = true;
                        }
                        if ( map[_x][_y] === 5 ) {
                            sandNearby = true;
                        }
                    }
                }
            }

            return !treesNearby && (waterNearby || sandNearby) ? 5 : 1;
        }
        generateGoldVeinsBeginings(){
            let newMap = [];
            for (let i = 0; i < this.size; i++) {
                newMap[i] = [];
                for (let m = 0; m < this.size; m++) {
                    if (this.map[i][m] === 1) {
                        if ( Math.random() > this.goldVeinChance ) {
                            newMap[i][m] = 6;
                            this.goldVeins.push({x:i,y:m});
                        } else {
                            newMap[i][m] = this.map[i][m];
                        }
                    } else {
                        newMap[i][m] = this.map[i][m];
                    }
                }
            }
            this.setMap(newMap);
        }
        goldNearby(x,y, except, map){
            let res = false;
            for ( let i = -1 ; i < 2 ; i++ ){
                for( let m = -1 ; m < 2; m++ ){
                    if ( Math.abs(i) === Math.abs(m) || (i === 0 && m === 0) ) {
                        continue;
                    }
                    let  _x = this.periodicFunction(this.size, x + i);
                    let  _y = this.periodicFunction(this.size, y + m);

                    if ( _x == except.x && _y == except.y ) {

                    } else if ( m === 0 && i === 0 ) {

                    } else if ( map[_x][_y] === 6 ) {
                        res = true;
                    }

                }
            }
            return res;
        }
        growGoldVeins(){
            let newMap = this.map;
            let oldGoldBeginnings = this.goldVeins;
            this.goldVeins = [];
            for( let i = 0 ; i < oldGoldBeginnings.length ; i++ ){
                for ( let m = -1 ; m < 2; m++ ) {
                    for ( let k = -1 ; k < 2 ; k++ ) {
                        if ( Math.abs(m) === Math.abs(k) || (m === 0 && k === 0) ) {
                            continue;
                        }
                        let  _x = this.periodicFunction(this.size, oldGoldBeginnings[i].x + m);
                        let  _y = this.periodicFunction(this.size, oldGoldBeginnings[i].y + k);
                        if ( this.map[_x][_y] === 1 && this.map[_x][_y] !== 6 ) {
                            if ( Math.random() > this.goldVeinsGrowChance && !this.goldNearby(_x,_y, oldGoldBeginnings[i], newMap) ) {
                                newMap[_x][_y] = 6;
                                this.goldVeins.push({x:_x,y:_y});
                            } else {
                                newMap[_x][_y] = 1;
                            }
                        }
                    }
                }
            }
            this.setMap(newMap);
        }
        paintMapOnCanvas() {
            let ctx = this.canvas.getContext('2d');
            let w = this.canvas.width / this.map.length;

            for ( let i = 0 ; i < this.map.length ; i++){
                for ( let m = 0 ; m < this.map.length ; m++){
                    if ( this.map[i][m] == 1 ) {
                        //grass
                        ctx.fillStyle = '#00ab2f';
                        ctx.fillRect(i*w,m*w,w,w);
                    } else if ( this.map[i][m] == 0 ) {
                        //water
                        ctx.fillStyle = '#0002ab';
                        ctx.fillRect(i*w,m*w,w,w);
                    } else if ( this.map[i][m] == 2 ) {
                        //tree
                        ctx.fillStyle = '#0d4a00';
                        ctx.fillRect(i*w,m*w,w,w);
                    } else if ( this.map[i][m] == 3 ) {
                        //stone
                        ctx.fillStyle = '#4b4749';
                        ctx.fillRect(i*w,m*w,w,w);
                    } else if ( this.map[i][m] == 4 ) {
                        //snow
                        ctx.fillStyle = '#ffffff';
                        ctx.fillRect(i*w,m*w,w,w);
                    } else if ( this.map[i][m] == 5 ) {
                        //beach
                        ctx.fillStyle = '#fcff40';
                        ctx.fillRect(i*w,m*w,w,w);
                    } else if ( this.map[i][m] == 6 ) {
                        //gold
                        ctx.fillStyle = '#8c5a00';
                        ctx.fillRect(i*w,m*w,w,w);
                    }
                }
            }
        }
    }

    document.addEventListener("DOMContentLoaded", function(event) {
        let canvas = document.getElementById('map');
        /* optymalne wartości : 50, 0.46, 19,18, 0.2, 0.9, 3 */
        let world = new World(
            200, //rozmiar mapy
            0.46, //odwrócona szansa na stworzenie żywej komórki 'trawy'
            19, //ilość potrzebnych komórek żywych w sąsiedztwie do ożywienia martwej komórki
            18, //ilość martwych komórek w sąsiedztwie potrzebnych do zabicia żywej komórki
            0.24, //odwrócona szansa na stworzenie drzewa
            0.7, //odwrócona szansa na stworzenie kamienia
            3, //promień komórek wchodzących w skład sąsiedztwa danej komórki
            10, //ilosc komorek kamienia w sasiedztwie potrzebnych do stworzenia gor
            17, //ilosc komorek wody w poblizu potrzebnych do tworzenia gor przy wodzie
            3, //promien komorek sasiedztwa kamienia
            18, //ilosc kamieni potrzebnych w otoczeniu zeby skala przezyla
            5, //obszar sprawdzajacy czy w otoczeniu sa same kamienie zeby osniezyc szczyty
            1, //obszar sprawdzajacy czy nie ma drzew w otoczeniu oraz czy komorka znajduje sie przy wodzie
            0.999//chance for gold vein begining
        );
        world.canvas = canvas;

        let generateRandomBt = document.getElementById('generateRandomFn');
        let reconstructMapBt = document.getElementById('reconstructMapFn');
        let plantTreesBt = document.getElementById('plantTreesFn');
        let reconstructTreesBt = document.getElementById('reconstructTreesFn');
        let placeStonesBt = document.getElementById('placeStonesFn');
        let reconstructStonesBt = document.getElementById('reconstructStonesFn');
        let placeSnowOnMountainPeaksBt = document.getElementById('placeSnowOnMountainPeaksFn');
        let placeBeachesBt = document.getElementById('placeBeachesFn');
        let generateGoldVeinsBeginingsBt = document.getElementById('generateGoldVeinsBeginingsFn');
        let growGoldVeinsBt = document.getElementById('growGoldVeinsFn');

        generateRandomBt.addEventListener('click', () => world.generateRandom(1));
        reconstructMapBt.addEventListener('click', () => world.reconstructMap(1));
        plantTreesBt.addEventListener('click', () => world.plantTrees(1));
        reconstructTreesBt.addEventListener('click', () => world.reconstructTrees(1));
        placeStonesBt.addEventListener('click', () => world.placeStones(1));
        reconstructStonesBt.addEventListener('click', () => world.reconstructStones(1));
        placeSnowOnMountainPeaksBt.addEventListener('click', () => world.placeSnowOnMountainPeaks(1));
        placeBeachesBt.addEventListener('click', () => world.placeBeaches(1));
        generateGoldVeinsBeginingsBt.addEventListener('click', () => world.generateGoldVeinsBeginings(1));
        growGoldVeinsBt.addEventListener('click', () => world.growGoldVeins(1));

        let infoText = document.getElementById('infoText');

        let step = 0;

        // world.reconstructMap(1);
        // world.plantTrees();
        // world.reconstructTrees(3);
        // world.placeStones();
    });

    function setInfo(elem, text){
        elem.innerText = text;
    }

</script>
<body style="text-align: center; background-color: black">
    <canvas id="map" width="200" height="200" style="width:500px; height: 500px; border:2px solid #000;"></canvas>
    <hr>
    <button id="generateRandomFn">GenerateRandom</button>
    <button id="reconstructMapFn">reconstructMap</button>
    <button id="plantTreesFn">plantTrees</button>
    <button id="reconstructTreesFn">reconstructTrees</button>
    <button id="placeStonesFn">placeStones</button>
    <button id="reconstructStonesFn">reconstructStones</button>
    <button id="placeSnowOnMountainPeaksFn">placeSnowOnMountainPeaks</button>
    <button id="placeBeachesFn">placeBeaches</button>
    <button id="generateGoldVeinsBeginingsFn">generateGoldVeinsBeginings</button>
    <button id="growGoldVeinsFn">growGoldVeins</button>
    <br><br>
    <span id="infoText" style="color:#fff">Pusta Mapa</span>
</body>
</html>